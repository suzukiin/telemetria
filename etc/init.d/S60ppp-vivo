#!/bin/sh

### BEGIN INIT INFO
# Provides:          ppp-vivo
# Required-Start:    $network $local_fs
# Required-Stop:
# Default-Start:     S
# Default-Stop:
# Short-Description: PPP Vivo LTE
### END INIT INFO

PEER="VIVO-PEERS"
PPP_IF="ppp0"
MODEM_DEV="/dev/ttyUSB2"

wait_for_modem() {
    echo "[ppp] aguardando modem $MODEM_DEV..."
    for i in $(seq 1 30); do
        [ -e "$MODEM_DEV" ] && return 0
        sleep 2
    done
    return 1
}

start() {
    echo "[ppp] iniciando PPP..."
    wait_for_modem || {
        echo "[ppp] modem não encontrado"
        return 1
    }

    # Evita múltiplas instâncias
    pidof pppd >/dev/null && {
        echo "[ppp] pppd já está rodando"
        return 0
    }

    pppd call "$PEER" &
}

stop() {
    echo "[ppp] parando PPP..."
    killall pppd
}

case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart)
        stop
        sleep 2
        start
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
        ;;
esac
